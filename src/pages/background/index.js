function i(e,t,a){chrome.tabs.query({url:e},function(n){n.length>0?chrome.tabs.sendMessage(n[0].id,{action:t,dados:a}):window.open(e,"_blank")})}async function c(){const e=await f("notifications"),t=[],a=[];let n=0;for(let o of e)!o.timeOut&&u(`${o.date}T${o.time}`)&&(o.timeOut=!0,a.push(o)),o.timeOut&&!o.read&&n++,t.push(o);i("https://web.whatsapp.com/*","Update_Notificação",{update:t,dispart:a,tam:n})}async function m(){const t=await fetch("https://backend.watidy.com/api/mysql/notification/list",{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>a.json()).then(a=>a).catch(a=>(console.error("error",a),a));t.success&&i("https://web.whatsapp.com/*","Update-Central-Notifications",{data:t.data})}chrome.alarms.onAlarm.addListener(e=>{switch(e.name){case"License":i("https://web.whatsapp.com/*","license_update",{});break;case"Notificações":c();break;case"Update-Central-Notifications":m();break}});function l(){chrome.alarms.get("Update-Central-Notifications",e=>{e||chrome.alarms.create("Update-Central-Notifications",{periodInMinutes:30})}),chrome.alarms.get("License",e=>{e||chrome.alarms.create("License",{periodInMinutes:5})}),chrome.alarms.get("Notificações",e=>{e||chrome.alarms.create("Notificações",{periodInMinutes:1})})}function u(e){const t=new Date(e),a=new Date,n=t.getTime()-a.getTime();return n<=12e4||n<0}async function f(e){return new Promise((t,a)=>{chrome.storage.local.get([e],function(n){n[e]===void 0?a():t(n[e])})})}async function s(){const e=await h();chrome.storage.local.get(null,t=>{chrome.storage.local.set({license:t.license||{estado:!1,login:"",senha:"",token:""},agendamentos:t.agendamentos||[],lang:t.lang||e.language,guardaMsg:t.guardaMsg||[],notifications:t.notifications||[],userTabs:t.userTabs||[],contatos:t.contatos||[],notes:t.notes||[],agendaMsg:t.agendaMsg||[],perfil:t.perfil||[],categoria:t.categoria||[],initSystem:t.initSystem||!1,finalizar:t.finalizar||[],backupAutomatico:t.backupAutomatico||{date:"",time:"",recurrency:"",items:[]},crm:t.crm||[],agrupamentos:t.agrupamentos||[],relatorio:t.relatorio||[]})})}async function h(){try{return await(await fetch(chrome.runtime.getURL("/label/config/utils.json"))).json()}catch(e){console.error("Erro ao carregar o arquivo JSON:",e)}}chrome.action.onClicked.addListener(()=>{r()});function r(){chrome.tabs.query({url:"https://web.whatsapp.com/*"},function(e){e.length>0?chrome.tabs.reload(e[0].id):chrome.tabs.create({url:"https://web.whatsapp.com"})})}chrome.runtime.onInstalled.addListener(async function(e){r(),l(),s()});chrome.runtime.onInstalled.addListener(function(e){e.reason==="update"&&s()});chrome.runtime.onMessage.addListener((e,t,a)=>{switch(e.message){case"CRM":chrome.tabs.query({url:chrome.runtime.getURL("src/pages/crm/index.html")},function(n){n.length>0?chrome.tabs.update(n[0].id,{active:!0},function(o){chrome.tabs.reload(o.id)}):chrome.tabs.create({url:chrome.runtime.getURL("src/pages/crm/index.html")})});break}return!0});
